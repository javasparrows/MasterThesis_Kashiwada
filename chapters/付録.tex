\chapter{付録}
% \section{一様球}
% 球内に一様分布する点を生成する際は、体積素を考慮する必要がある。3次元極座標での単位球は、$0<r<1, 0<\theta<\pi, 0<\phi<2\pi$として
% \begin{align}
% \begin{aligned}
%     \begin{cases}
%     x = r\sin{\theta}\cos{\phi}\\
%     y = r\sin{\theta}\sin{\phi}\\
%     z = r\cos{\theta}
%     \end{cases}
% \end{aligned}
% \end{align}
% となる。この時の体積素は$dV = r^2\sin{\theta}{\rm d}r{\rm d}\theta{\rm d}\phi$となるから、
% \begin{align}
% \begin{aligned}
%     \int dV =& -\frac{1}{3}r^3 \cos{\theta}\phi\\
% \end{aligned}
% \end{align}
% ここで、座標を
% \begin{align}
% \begin{aligned}
%     (R,\Theta,\phi) = \left(\frac{1}{3}r^3,-\cos{\theta},\phi \right)
% \end{aligned}
% \end{align}
% とすると、それぞれの座標の範囲は$0<R<\frac{1}{3}, -1<\Theta<1, 0<\phi<2\pi$となる。ここで、$\frac{1}{3}r^3 \to r^3, -\cos{\theta} \to \cos{\theta}$すると、
% \begin{align}
% \begin{aligned}
%     \begin{cases}
%     r = R^{\frac{1}{3}}  &(0<R<1)\\
%     \theta = \arccos{\Theta}  &(-1<\Theta<1)\\
%     \phi = \phi  &(0<\phi<2\pi)
%     \end{cases}
% \end{aligned}
% \end{align}
% となるから、
% \begin{align}
% \begin{aligned}
%     \begin{cases}
%     R  &(0<R<1)\\
%     \Theta  &(-1<\Theta<1)\\
%     \phi  &(0<\phi<2\pi)\\
%     \end{cases}
%     \label{一様球1}
% \end{aligned}
% \end{align}
% を用いて
% \begin{align}
% \begin{aligned}
%     \begin{cases}
%     x = R^{\frac{1}{3}}\sqrt{1-\Theta^2}\cos{\phi}\\
%     y = R^{\frac{1}{3}}\sqrt{1-\Theta^2}\sin{\phi}\\
%     z = R^{\frac{1}{3}}\Theta
%     \end{cases}
%     \label{一様球2}
% \end{aligned}
% \end{align}
% と表せることになる。したがって、球内に一様分布する点を生成したいときには、式(\ref{一様球1})の範囲で$R,\Theta,\phi$のそれぞれの一様乱数を用いて式(\ref{一様球2})から生成することができる。

% \section{誤差伝播}
% \subsection{年周視差}
% 年周視差の誤差は、$\sigma_r = \sigma_{\varpi}/\varpi^2$と計算
% (\cite{BJ15})


% \subsection{速度}
% \subsection{Cov$(v_R,v_{\phi},v_z)$ to Cov$(d,v_R,\mu_l,\mu_b)$}
% \begin{align}
% \begin{aligned}
% 	{\rm Cov}(v_R,v_l,v_b) = {\bm R} \ {\rm Cov}(v_R,v_{\phi},v_z) \ {\bm R^{-1}}
% \end{aligned}
% \end{align}
% Where ${\bm R}$ is the transformation matrix from $(v_R,v_{\phi},v_z)$ to $(v_R,v_l,v_b)$. At first, transformation from $(v_R,v_{\phi},v_z)$ to $(U,V,W)$ is as follows;
% \begin{align}
% \begin{aligned}
% 	\left(
% 	\begin{array}{c}
% 	 	U \\
% 	 	V \\
% 	 	 W
% 	\end{array}
% 	\right)
% 	= {\bm T}
% 	\left(
% 	\begin{array}{c}
% 	 	v_R\\
% 	 	v_{\phi}\\
% 	 	v_z
% 	\end{array}
% 	\right)
% \end{aligned}
% \end{align}



% \section{平均値の標準誤差}
% 正規分布に従う量$x$について$N$個の測定値$x_1,\cdots,x_N$を得た場合、真の値$X$の最良推定値は$x_1,\cdots,x_N$の平均値$\bar{x}$である。この推定値の誤差は平均値の標準誤差
% \begin{align}
%     \sigma_{\bar{x}} = \sigma_{x}/\sqrt{N}
% \end{align}
% である。平均値は、$N$個の値$x_1,\cdots,x_N$を測定し、次の関数
% \begin{align}
%     \bar{x} = \frac{x_1+ \cdots x_N}{N}  \label{平均値}
% \end{align}
% を計算する。

% \begin{align}
%     \frac{X+ \cdots +X}{N} = X
% \end{align}
% 誤差伝搬を考慮すれば、平均値$\bar{x}$の分布の幅は
% \begin{align}
%      \sigma_{\bar{x}} = \sqrt{\left(\frac{\partial \bar{x}}{\partial x_1}\sigma_{x_1}\right)^2 + \cdots + \left(\frac{\partial \bar{x}}{\partial x_N}\sigma_{x_N}\right)^2}  \label{eqA1}
% \end{align}
% である。$x_1,\cdots,x_N$はすべて同一量$x$についての推定値なので、幅はすべて同じで$\sigma_x$に等しい。したがって
% \begin{align}
%      \sigma_{x_1}= \dots =\sigma_{x_N}=\sigma_x
% \end{align}
% である。また、式(\ref{平均値})によって式(\ref{eqA1})の偏微分がすべて同じであることがわかる。つまり
% \begin{align}
%      \frac{\partial \bar{x}}{\partial x_1}= \cdots = \frac{\partial \bar{x}}{\partial x_N} = \frac{1}{N}
% \end{align}
% である。したがって、式(\ref{eqA1})は
% \begin{align}
%      \sigma_{\bar{x}} = \sqrt{\left(\frac{1}{N}\sigma_{x_1}\right)^2+ \cdots +\left(\frac{1}{N}\sigma_{x_N}\right)^2} = \sqrt{N\frac{\sigma_x^2}{N^2}} = \frac{\sigma_x}{\sqrt{N}}
% \end{align}
% となる。


% \section{速度分散のエラーバー}
% $i$方向の速度分散を$\sigma_i$、その速度分散のエラーを$e_{\sigma_i}$、星の数を$N$とすると、
% \begin{align}
%      e_{\sigma} = (2N)^{-1/2} \sigma_i
% \end{align}
% と表せる(\cite{Anguiano2018})。

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \section{Likelihood}
% 使用する観測量は$l_{\rm i},b_{\rm i},\varpi_{\rm i},\mu_{l,\rm i},\mu_{b,\rm i},v_{R, \rm i},\sigma_{\mu_{l,\rm i}},\sigma_{\mu_{b,\rm i}},\sigma_{v_{R,\rm i}}$である。$\rm i$は、i番目の天体のデータであることを意味する。

% Oort-Lindbladモデルでは、固有運動と視線速度を
% \begin{align}
% \begin{aligned}
% 	\mu_l(l_i,b_i,\varpi_i) &= (A\cos2l_i - C\sin2l_i + B)\cos b_i + \varpi(u_0\sin l_i - v_0\cos l_i) \\
% 	\mu_b(l_i,b_i,\varpi_i) &= -(A\sin2l_i + C\cos2l_i + K)\sin b_i \cos b_i \\
% 	                          & \hspace{2cm} + \varpi_i[(u_0\cos l_i + v_0 \sin l_i)\sin b_i - w_0 \cos b_i] \\
% 	v_R(l_i,b_i,\varpi_i) &= (K + C\cos2l_i + A\sin2l_i)\cos^2 b_i / \varpi \\
% 	                      & \hspace{2cm} - [(u_0\cos l_i + v_0 \sin l_i)\cos b_i + w_0 \sin b_i]
% \end{aligned}
% \end{align}
% のように記述できる。

% これらを使って、Likelihood関数は
% \begin{align}
% \begin{aligned}
% 	\mathcal{L} = & \prod_i \left( N\left[ \mu_l^i - \mu_l(l_i,b_i,\varpi_i), \ \sqrt{\sigma_{\mu_l}^2 + (s_{\mu_l}^i)^2}\ \right] \right. \\
% 	& N\left[ \mu_b^i - \mu_b(l_i,b_i,\varpi_i), \ \sqrt{\sigma_{\mu_b}^2 + (s_{\mu_b}^i)^2} \ \right] \\
% 	& \left. N\left[ v_R^i - v_R(l_i,b_i,\varpi_i), \ \sqrt{\sigma_{v_R}^2 + (s_{v_R}^i)^2} \ \right] \right)
% \end{aligned}
% \end{align}

% \begin{align}
% \begin{aligned}
% 	L =& -\frac{1}{2}\sum_i \left(\frac{\left[\mu_l^i - \mu_l(l_i,b_i,\varpi_i)\right]^2}{\sigma_{\mu_l}^2 + (s_{\mu_l}^i)^2}  + {\rm ln}\left[\sigma_{\mu_l}^2 + (s_{\mu_l}^i)^2\right] \right. \\
% 	& = \left. \frac{\left[\mu_b^i - \mu_b(l_i,b_i,\varpi_i)\right]^2}{\sigma_{\mu_b}^2 + (s_{\mu_b}^i)^2}  + {\rm ln}\left[\sigma_{\mu_b}^2 + (s_{\mu_b}^i)^2\right] \right. \\
% 	&= \left. \frac{\left[v_R^i - v_R(l_i,b_i,\varpi_i)\right]^2}{\sigma_{v_R}^2 + (s_{v_R}^i)^2} + {\rm ln}\left[\sigma_{v_R}^2 + (s_{v_R}^i)^2\right] \right)
% \end{aligned}
% \end{align}

% と書ける。フィッティングパラメータは$A,B,C,K,u_0,v_0,w_0,s_{\mu_l},s_{\mu_b},s_{v_{\mathrm{los}}}$の10個を用いる。$s_{\mu_l},s_{\mu_b},s_{v_{\mathrm{los}}}$はそれぞれ$\mu_l,\mu_b,v_R$の分散を表す。

% \begin{align}
% \begin{aligned}
% 	{\rm ln} L =& -\frac{1}{2}\sum_i \left(\frac{\left[\mu_l^i - \mu_l(l_i,b_i,\varpi_i)\right]^2}{\sigma_{\mu_l}^2 + (s_{\mu_l}^i)^2}  + {\rm ln}\left[\sigma_{\mu_l}^2 + (s_{\mu_l}^i)^2\right] \right. \\
% 	& = \left. \frac{\left[\mu_b^i - \mu_b(l_i,b_i,\varpi_i)\right]^2}{\sigma_{\mu_b}^2 + (s_{\mu_b}^i)^2}  + {\rm ln}\left[\sigma_{\mu_b}^2 + (s_{\mu_b}^i)^2\right] \right. \\
% 	&= \left. \frac{\left[v_R^i - v_R(l_i,b_i,\varpi_i)\right]^2}{\sigma_{v_R}^2 + (s_{v_R}^i)^2} + {\rm ln}\left[\sigma_{v_R}^2 + (s_{v_R}^i)^2\right] \right)
% \end{aligned}
% \end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% \section{オールト定数}
% 座標系と速度の向きを図(\ref{fig:coordinates})のようにとる。このとき、
% \begin{align}
% \begin{aligned}
%     \begin{cases}
%     x = -R\cos{\phi} - R_{\odot}\\
%     y = R\sin{\phi}
%     \end{cases}
% \end{aligned}
% \end{align}

% \begin{align}
% \begin{aligned}
%     \begin{cases}
%     R = \sqrt{(x+R_{\odot})^2 + y^2}\\
%     \phi = \arctan{c\frac{y}{-x-R_{\odot}}}
%     \end{cases}
% \end{aligned}
% \end{align}


% \begin{align}
% \begin{aligned}
% 	\left(
% 	\begin{array}{c}
% 	 	V_x \\
% 	 	V_y
% 	\end{array}
% 	\right)
% 	=
% 	\left(
% 	\begin{array}{cc}
% 	 	\cos{\phi} & \sin{\phi}\\
% 	 	-\sin{\phi} & \cos{\phi}
% 	\end{array}
% 	\right)
% 	\left(
% 	\begin{array}{cc}
% 	 	-v_R \\
% 	 	V_{\phi}
% 	\end{array}
% 	\right)
% \end{aligned}
% \end{align}

% 太陽近傍で考える($\phi=0$で$R=R_{\odot}$)と、$\cfrac{\partial R}{\partial x} = -1, \cfrac{\partial R}{\partial y} = 0, \cfrac{\partial \phi}{\partial x} = 0, \cfrac{\partial \phi}{\partial y} = \cfrac{1}{R_{\odot}}$より、
% \begin{align}
% \begin{aligned}
%     \frac{\partial V_x}{\partial x} &= \frac{\partial R}{\partial x}\frac{\partial v_R}{\partial R} + \frac{\partial \phi}{\partial x}\frac{\partial V_x}{\partial \phi} = \frac{\partial V_x}{\partial R}\\
%     \frac{\partial V_x}{\partial y} &= \frac{\partial R}{\partial y}\frac{\partial V_x}{\partial R} + \frac{\partial \phi}{\partial y}\frac{\partial V_x}{\partial \phi} = \frac{1}{R_{\odot}}\left(-\frac{\partial v_R}{\partial \phi} + V_{\phi} \right) \\
%     \frac{\partial V_y}{\partial x} &= \frac{\partial R}{\partial x}\frac{\partial V_y}{\partial R} + \frac{\partial \phi}{\partial x}\frac{\partial V_y}{\partial \phi} = -\frac{\partial V_{\phi}}{\partial R}\\
%     \frac{\partial V_y}{\partial y} &= \frac{\partial R}{\partial y}\frac{\partial V_y}{\partial R} + \frac{\partial \phi}{\partial y}\frac{\partial V_y}{\partial \phi} = \frac{1}{R_{\odot}}\left(\frac{\partial V_{\phi}}{\partial \phi}+v_R\right)
% \end{aligned}
% \end{align}

% となるから、
% \begin{align}
% \begin{aligned}
%     A &= \frac{1}{2}\left(\frac{\partial V_x}{\partial y} + \frac{\partial V_y}{\partial x}\right) = \frac{1}{2}\left(\frac{V_{\phi}}{R_{\odot}} - \frac{\partial V_{\phi}}{\partial R} - \frac{1}{R_{\odot}}\frac{\partial v_R}{\partial \phi}\right) \\
%     B &= \frac{1}{2}\left(-\frac{\partial V_x}{\partial y} + \frac{\partial V_y}{\partial x}\right) = \frac{1}{2}\left(-\frac{V_{\phi}}{R_{\odot}} - \frac{\partial V_{\phi}}{\partial R} + \frac{1}{R_{\odot}}\frac{\partial v_R}{\partial \phi}\right) \\
%     C &= \frac{1}{2}\left(\frac{\partial V_x}{\partial x} - \frac{\partial V_y}{\partial y}\right) = \frac{1}{2}\left(-\frac{v_R}{R_{\odot}} + \frac{\partial v_R}{\partial R} - \frac{1}{R_{\odot}}\frac{\partial V_{\phi}}{\partial \phi}\right) \\
%     K &= \frac{1}{2}\left(\frac{\partial V_x}{\partial x} + \frac{\partial V_y}{\partial y}\right) = \frac{1}{2}\left(\frac{v_R}{R_{\odot}} + \frac{\partial v_R}{\partial R} + \frac{1}{R_{\odot}}\frac{\partial V_{\phi}}{\partial \phi}\right)
% \end{aligned}
% \end{align}
% と書ける。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \section{統計}
% 統計学は大きく頻度主義とベイズ主義の 2 つに分けられる。

% \subsection{最小二乗法}
% \subsubsection{基礎}
% 最小二乗法は、最尤性原理(principle of maximum likelihood)を用いた方法である。この原理を用いた、最良推定値を求める方法を最尤推定法と呼ぶ。これは頻度主義と呼ばれる。

% \begin{enumerate}
% 	\item{まず、真のモデルがある。我々はその真のモデルから発生した観測値を手に入れている。 真の値は一つであり、観測値は取り方によって確率的に変化する。というのが頻度論の 基本的な発想。}
% 	\item{データは確率的なものであるが、真のモデルの推定値は、手元の観測値が最も得られや すいものとする。}
% \end{enumerate}

%  最尤推定法では、観測値がガウス分布に従っていると仮定する。 ベイズ推定では、事後分布は次のように書ける。
% \begin{align}
% 	事後分布 &= \frac{事前分布 \times 尤度}{観測値の分布} \\
% 			&\propto 事前分布 \times 尤度
% \end{align}

% 観測値の分布は確率の形に戻す(正規化する)ための定数と考えれば、重要なのは事前分布 と尤度である。
% 最尤推定法は尤度だけから真値を推定するが、ベイズ推定では事前分布を掛けている。正 確に言うと、最尤推定法は事前分布に一様分布を仮定している。すると、
% \begin{align}
% 	一様分布 \times 尤度
% \end{align}
% の確率分布の最頻値(尤度が最大の値)が最尤推定量となる。しかし、ベイズ推定では値で はなく確率分布で与えられる。

% \subsection{MCMC法}
% マルコフ連鎖を利用したモンテカルロ法を用いると、データの分布を計算せずに直接事後分布を求めることができる。

% \subsubsection{基礎}

% 事前分布が multimodal な分布の場合、最小二乗法などの 1 つの値を exact に決める方法を 適用すべきではない。このような場合、ベイズ統計の手法を用いて事後分布を求める方法が 有効に働く。この方法としてよく使われるのがマルコフ連鎖モンテカルロ法(MCMC)と呼 ばれるものである。マルコフ連鎖(Markov chain)とは、ひとつのステップの中で前の状態 に基づいて次の状態を作り出すことをいうい。また一般に、乱数を用いた計算アルゴリズム をモンテカルロ法と呼ぶ(カジノで有名なためにこう名付けられたらしい。ラスベガス法という別の方法も存在する)。

% モンテカルロ法は、真にランダムにサンプリングを行うため
% \begin{itemize}
% 	\item{計算コストがかさむ}
% 	\item{精度も向上しない}
% \end{itemize}
% という課題がある。MCMC は、マルコフ連鎖を定常分布としたサンプリングを行うことで、 上記課題を改善した方法である。

% MCMC 法のアルゴリズムは、以下の通りである。
% \begin{enumerate}
% 	\item{初期点を決める}
% 	\item{マルコフ連鎖により次のサンプリングを行う分布を決定する}
% 	\item{分布が収束をするまで、2を繰り返す}
% \end{enumerate}
% 基本的なアルゴリズムはこのようなものであるが、さらに具体的なアルゴリズムにはいくつかの方法がある。それらの中で最も基本的な方法はメトロポリス・ヘイスティング法と呼ばれるものである。この他にも、ハミルトニアン・モンテカルロ法やギブス・サンプリング法と呼ばれるものがある。次章では、最もMCMCの最も基本的なアルゴリズムであるメトロポリス・ヘイスティング法について触れる。

% \subsubsection{メトロポリス・ヘイスティング法}
% 自作コードではメトロポリス・ヘイスティング法(MH 法)を用いている。
% \begin{enumerate}
% 	\item{$a \sim q(a|\theta_t)$からパラメータの候補$a$を生成する}
% 	\item{$\cfrac{q(\theta|a)f(a)}{q(a|\theta_t)f(\theta_t)}$を計算する}
% 	\item{確率${\rm min}(1,r)$ で$a$を受容し、$\theta_{t+1} = a$とする}
% \end{enumerate}
% を繰り返してパラメータを更新していく。よって、現在のパラメータから新しいパラメータを生成するときの確率$q(a|\theta_t)$、および、尤度$f$を計算するときの分布の形状(提案分布)を決めると、パラメータを推定することができる。提案分布は正規分布としたときの平均と標準偏差が一般的に求められる値である。
% この方法の課題は、(1) 受容率が低く、事後分布に従うサンプルを十分に得られない。(2) 前後のサンプルの相関が高く、パラメータ空間を網羅できない。というものがある。パラメー タ数が少ない低次元であれば遷移核は容易に分かるが、数十以上の高次元空間だと、事後分布の形状自体の確認が難しくなる。そこで、上記の課題を解決するのがハミルトニアン・モンテカルロ法である。

% \subsubsection{ハミルトニアン・モンテカルロ法}
% まず、何かの粒子が$N$個あるとして、粒子$i$の位置が$x_i$、運動量が$p_i$だとする。系全体の状態は、$(x,p) = ({x_i},{p_i})$で表される。すると、それぞれの粒子は以下のハミルトン方程式にしたがって運動する。
% \begin{align}
% \begin{aligned}
% 	\frac{dx_i(t)}{dt} =& \frac{\partial H(x,p)}{\partial p_i} \\
% 	\frac{dp_i(t)}{dt} =& -\frac{\partial H(x,p)}{\partial x_i}
% \end{aligned}
% \end{align}
% ハミルトン方程式の重要な性質は、(x,p)空間の確率密度関数$q(x,p)$の値が$H$だけの関数であるとき、すなわち、$q(x,p) = r(H(x,p))$という形をしているとき、それがハミルトン方程式による状態変化について定常分布担っていることである。


% ハミルトニアンとは、物体の持つ力学的エネルギーを、位相空間で表現したものである。位相空間とは、運動量と位置で張られる空間である。力学的エネルギー保存の法則より、ハミルトニアンは時間によらず一定である。この性質を利用して、うまく事後確率のサンプルを得る。慣性付きの勾配法のようなものである。このアルゴリズムは次のようになる。
% \begin{enumerate}
% 	\item{運動量$p$を標準正規乱数から発生させる。}
% 	\item{ポテンシャル$h(\theta)$を対数事後分布として、慣性付きの勾配法を進めて、$L$ステップ後 の値を$\theta_a$とする。}
% 	\item{$r=exp(H(\theta_t,p_t)−H(\theta_a,p_a))$を求める。}
% 	\item{確率${\rm min}(1, r)$でパラメータ$\theta_a$を受容する。}
% \end{enumerate}
% ここで、$H$はハミルトニアンで、$H(\theta,p) = h(\theta) + 1p\cdot p$である。


\section{ジーンズ方程式 \label{sec_JeansEq}}
\subsection{無衝突ボルツマン方程式}
無衝突ボルツマン方程式は次のような式である。
\begin{align}
	\frac{\partial f}{\partial t} + \bm{v} \cdot \frac{\partial f}{\partial \bm{x}} - \frac{\partial \Phi}{\partial \bm{x}} \cdot \frac{\partial f}{\partial \bm{v}} = 0 \label{CBE}
\end{align}
ここで、$f$は分布関数であり、位置と速度に関する関数$f(\pmb{x},\pmb{v})$である。ある$\pmb{x}、\pmb{v}$に星が存在する確率を表す。

\subsection{球対称系でのジーンズ方程式}
球座標系と直交座標系の間の変換式は次のようになる。
\begin{align}
	\begin{cases}
		x &= r\sin\theta \cos\phi \\
		y &= r\sin\theta \sin\phi \\
		z &= r\cos\theta
	\end{cases}
\end{align}
両辺で時間微分を行うと
\begin{align}
	\begin{cases}
		\dot{x} =& \dot{r}\sin{\theta} \cos{\phi} + r\dot{\theta}\cos{\theta} \cos{\phi} - r\dot{\phi}\sin\theta \sin\phi \\
		\dot{y} =& \dot{r}\sin{\theta} \sin{\phi} + r\dot{\theta}\cos{\theta} \sin{\phi} + r\dot{\phi}\sin{\theta} \cos{\phi} \\
		\dot{z} =& \dot{r}\cos{\theta} - r\dot{\theta}\sin{\theta}
	\end{cases}
\end{align}
のようになる。このとき、運動エネルギー$T$は
\begin{align}
	T &= \frac{1}{2}(\dot{x}+\dot{y}+\dot{z}) \\
	&= \frac{1}{2}(\dot{r}^2 + r^2\dot{\theta}^2 + r^2\dot{\phi}^2\sin^2\theta)
\end{align}
となり、ラグランジアン$\mathcal{L}$は
\begin{align}
	\mathcal{L} &= T - \Phi \\
	&= \frac{1}{2}(\dot{r}^2 + r^2\dot{\theta}^2 + r^2\dot{\phi}^2\sin^2\theta) - \Phi(r)
\end{align}
となる。

位置ベクトルを$\bm r$、直交座標系及び球座標系での単位ベクトルを$(\bm e_x, \bm e_y, \bm e_z)$、$(\bm e_r, \bm e_{\theta}, \bm e_{\phi})$とすると、$\bm r = r\sin{\theta} \cos{\phi} \bm e_x + r\sin{\theta} \sin{\phi} \bm e_y + r\cos{\theta} e_z$と書ける。このとき、
\begin{align}
	\begin{cases}
		\bm{e_r} &= \frac{\partial \bm r}{\partial r} / \left| \frac{\partial \bm r}{\partial r}\right| \\
		\bm{e_{\theta}} &= \frac{\partial \bm r}{\partial \theta} / \left| \frac{\partial \bm r}{\partial \theta}\right| \\
		\bm{e_{\phi}} &= \frac{\partial \bm r}{\partial \phi} / \left| \frac{\partial \bm r}{\partial \phi}\right|
	\end{cases}
\end{align}
と表される。球座標系の場合、各座標軸の速度は
\begin{align}
	\begin{cases}
		v_R &= \frac{\partial r}{\partial t}|\frac{\partial \bm r}{\partial r}| = \dot{r}\\
		v_{\theta} &= \frac{\partial \theta}{\partial t}|\frac{\partial \bm r}{\partial \theta}| = r\dot{\theta}\\
		v_{\phi} &= \frac{\partial \phi}{\partial t}|\frac{\partial \bm r}{\partial \phi}| = r\sin\theta\dot{\phi}\\
	\end{cases}
\end{align}
となる。ここで、一般化運動量$p_i$は、一般化座標$q_i$、一般のラグランジアン$\mathcal{L}$を用いて
\begin{align}
	p_i \equiv \frac{\partial \mathcal{L}}{\partial \dot{q_i}}
\end{align}
で定義される。球座標系での運動量は次のように表される。
\begin{align}
	\begin{cases}
		p_r &= \frac{\partial \mathcal{L}}{\partial r} = \dot{r} = v_R \\
		p_{\theta} &= \frac{\partial \mathcal{L}}{\partial \theta} = r^2\dot{\theta} = r v_{\theta} \\
		p_{\phi} &= \frac{\partial \mathcal{L}}{\partial \phi} = r^2\sin^2\theta\dot{\phi} = r\sin\theta v_{\phi} \label{momenta}
	\end{cases}
\end{align}
また、体積積分は、ヤコビアン$\mathcal{J}$を用いて
\begin{align}
	\int dp_r dp_{\theta} dp_{\phi}f &= \int \mathcal{J} dv_R dv_{\theta} dv_{\phi}\\
	&=
	\int
	\left|
	\begin{array}{ccc}
	 	\cfrac{\partial p_r}{\partial v_R} & \cfrac{\partial p_r}{\partial v_{\theta}} & \cfrac{\partial p_r}{\partial v_{\phi}}\\
		\cfrac{\partial p_{\theta}}{\partial v_R} & \cfrac{\partial p_{\theta}}{\partial v_{\theta}} & \cfrac{\partial p_{\theta}}{\partial v_{\phi}}\\
		\cfrac{\partial p_{\phi}}{\partial v_R} & \cfrac{\partial p_{\phi}}{\partial v_{\theta}} & \cfrac{\partial p_{\phi}}{\partial v_{\phi}}
	\end{array}
	\right| 
	 dv_R dv_{\theta} dv_{\phi}\\
	&= r^2\sin\theta \int dv_R dv_{\theta} dv_{\phi}f = r^2 \sin\theta \nu    \label{integral}
\end{align}
と変換できる。

したがって、球座標系でのハミルトニアンは
\begin{align}
	\mathcal{H} &= \sum_i p_i \dot{q_i} - \mathcal{L} \\
	&= p_r\dot{r} + p_{\theta}\dot{\theta} + p_{\phi}\dot{\phi} - \left[\frac{1}{2}(\dot{r}^2 + r^2\dot{\theta}^2 + r^2\dot{\phi}^2\sin^2\theta) - \Phi(r) \right] \\
	&= \frac{1}{2}\left(p_r^2 + \frac{p_{\theta}^2}{R^2} + \frac{p_{\phi}^2}{r^2\sin^2\theta}\right) + \Phi(r) \\
\end{align}
と表される。式(\ref{CBE})に代入すると、
\begin{align}
	\frac{\partial f}{\partial t} &+ p_r\frac{\partial f}{\partial r} + \frac{p_{\theta}}{r^2} + \frac{\partial f}{\partial \phi} - \left(\frac{\partial \Phi}{\partial r} - \frac{p_{\theta}^2}{r^3} - \frac{p_{\theta}^2}{r^3 \sin^2\theta}\right)\frac{\partial f}{\partial p_r} \\
	&- \left(\frac{\partial \Phi}{\partial \theta} - \frac{p^2_{\phi}\cos\theta}{r^2\sin^3\theta}\frac{\partial f}{\partial p_{\theta}}\right) - \frac{\partial \Phi}{\partial \phi}\frac{\partial f}{\partial p_\phi} = 0   \label{CBE_spherical}
\end{align}
のようになる。系が球対称で時間に独立であると仮定すると、$\partial\Phi/\partial\theta, \partial\Phi/\partial\phi, \partial f/\partial t, \partial f/\partial \phi$は落とすことができる。$f$の$v_{\phi}$への依存は$v_{\phi} = p_{phi}/r\sin\theta$より$v_{\phi}$の$\theta$依存を生む可能性があるため、$\partial f/\partial \theta$は落とさずこのままにする。すると、式(\ref{CBE_spherical})は
\begin{align}
	p_r\frac{\partial f}{\partial r} + \frac{p_{\theta}}{r^2} - \left(\frac{\partial \Phi}{\partial r} - \frac{p_{\theta}^2}{r^3} - \frac{p_{\theta}^2}{r^3 \sin^2\theta}\right)\frac{\partial f}{\partial p_r} + \frac{p^2_{\phi}\cos\theta}{r^2\sin^3\theta}\frac{\partial f}{\partial p_{\theta}} = 0
\end{align}
となる。この式に$p_r dp_r dp_{\theta} dp_{\phi}$をかけて全運動量で積分する。
\begin{align}
	\int \left[p_r^2 \frac{\partial f}{\partial r} + \frac{p_r p_{\theta}}{r^2} - \left(\frac{\partial \Phi}{\partial r} - \frac{p_{\theta}^2}{r^3} - \frac{p_{\theta}^2}{r^3 \sin^2\theta}\right) p_r \frac{\partial f}{\partial p_r} + \frac{p_r p^2_{\phi}\cos\theta}{r^2\sin^3\theta}\frac{\partial f}{\partial p_{\theta}} \right]dp_r dp_{\theta} dp_{\phi} = 0 \label{CBE_spherical_simple}
\end{align}

式(\ref{integral})を用い、ガウスの発散定理によって運動量についての微分を消去する。式(\ref{CBE_spherical_simple})の左辺各項は
\begin{align}
\begin{aligned}
	\int p_r\frac{\partial f}{\partial r}dp_r dp_{\theta} dp_{\phi} &= \frac{\partial}{\partial r} \int p_r^2 f dp_r dp_{\theta} dp_{\phi} \\
	&= \frac{\partial}{\partial r} \left(r^2\sin\theta \int p_r^2f dv_R dv_{\theta} dv_{\phi} \right) \\
	&= \frac{\partial}{\partial r} \left(r^2\sin\theta \nu \overline{p_r^2} \right) \\
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
	\int \frac{p_r p_{\theta}}{r^2} \frac{\partial f}{\partial \theta} dp_r dp_{\theta} dp_{\phi} &= \frac{\partial}{\partial \theta} \int \frac{p_r p_{\theta}}{r^2} f dp_r dp_{\theta} dp_{\phi} \\
	&= \frac{\partial}{\partial \theta}(\sin\theta \nu \overline{p_r p_{\theta}}) \\
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
	\int \left(\frac{\partial \Phi}{\partial r} - \frac{p_{\theta}^2}{r^3} - \frac{p_{\theta}^2}{r^3 \sin^2\theta} \right) & p_r \frac{\partial f}{\partial p_r}dp_r dp_{\theta} dp_{\phi} \\
	&= \int \frac{\partial}{\partial p_r} \left[ \left(\frac{\partial \Phi}{\partial r} - \frac{p_{\theta}^2}{r^3} - \frac{p_{\theta}^2}{r^3 \sin^2\theta} \right) p_r f\right] dp_r dp_{\theta} dp_{\phi} \\
	& \hspace{1cm }- \int \left(\frac{\partial \Phi}{\partial r} - \frac{p_{\theta}^2}{r^3} - \frac{p_{\theta}^2}{r^3 \sin^2\theta} \right) f dp_r dp_{\theta} dp_{\phi} \\
	&= - \int \left(\frac{\partial \Phi}{\partial r} - \frac{p_{\theta}^2}{r^3} - \frac{p_{\theta}^2}{r^3 \sin^2\theta} \right) f dp_r dp_{\theta} dp_{\phi} \\
	&= - r^2\sin\theta \nu \left(\frac{\partial \Phi}{\partial r} - \frac{\overline{p_{\theta}^2}}{r^3} - \frac{\overline{p_{\theta}^2}}{r^3 \sin^2\theta} \right) \\
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
	\int \frac{p_r p^2_{\phi}\cos\theta}{r^2\sin^3\theta}\frac{\partial f}{\partial p_{\theta}}& dp_r dp_{\theta} dp_{\phi} \\
	&= \int \left[ \frac{\partial}{\partial p_{\theta}}\frac{p_r p^2_{\phi}\cos\theta}{r^2\sin^3\theta}f\right] dp_r dp_{\theta} dp_{\phi} \\
	& \hspace{1cm}- \int \frac{2p_r p_{\phi}\cos\theta}{r^2\sin^3\theta}f dp_r dp_{\theta} dp_{\phi} \\
	&= -\int \frac{2p_r p_{\phi}\cos\theta}{r^2\sin^3\theta}f dp_r dp_{\theta} dp_{\phi} \\
	&= -\frac{2\overline{p_r}\overline{p_{\phi}}\cos\theta\nu}{\sin\theta} \\
\end{aligned}
\end{align}

となる。また、任意の球対称系では分布関数は$f(\mathcal{H}, \bm L)$の形になり、そのため$v_R$の偶関数となるから、$\overline{p_r p_{\theta}} = r\overline{v_R v_{\theta}}$は消えなければならないため、式(\ref{CBE_spherical_simple})は
\begin{align}
	\frac{\partial}{\partial r}(r^2\sin\theta\nu\overline{p_r^2}) + \frac{\partial}{\partial \theta}(\sin\theta\nu\overline{p_rp_{\theta}}) + r^2\sin\theta\nu\left(\frac{d\Phi}{dr} - \frac{\overline{p_{\theta}^2}}{r^3} - \frac{\overline{p_{\phi}^2}}{r^3\sin^2\theta}\right)
\end{align}
となる。最後に、$r^2\sin\theta$で割り、式(\ref{momenta})を用いると
\begin{align}
	\frac{d(\nu \overline{v_R^2})}{dr} + \nu \left(\frac{d\Phi}{dr} + \frac{2\overline{v_R^2} - \overline{v_{\theta}^2} - \overline{v_{\phi}^2}}{r} \right) = 0
\end{align} 
という式になる。


\subsection{円筒座標系でのジーンズ方程式}
円筒座標系と直交座標系の間の変換式は次のようになる。
\begin{align}
	\begin{cases}
		x &= R\cos\phi \\
		y &= R\sin\phi \\
		z &= z
	\end{cases}
\end{align}

両辺で時間微分を行うと
\begin{align}
	\begin{cases}
		\dot{x} =& \dot{R}\cos\phi - R\dot{\phi}\sin\phi \\
		\dot{y} =& \dot{R}\sin\phi + R\dot{\phi}\cos\phi \\
		\dot{z} =& \dot{z}
	\end{cases}
\end{align}
のようになる。このとき、ラグランジアンは
\begin{align}
	\mathcal{L} = \frac{1}{2}(\dot{R^2} + R^2\dot{\phi}^2 + \dot{z^2})
\end{align}
となる。

位置ベクトルを$\bm r$、直交座標系及び円筒座標系での単位ベクトルを$(\bm e_x, \bm e_y, \bm e_z)$、$(\bm e_R, \bm e_{\phi}, \bm e_z)$とすると、$\bm r = R\cos\phi \bm e_x + R\sin\phi \bm e_y + z \bm e_z$と書ける。このとき、
\begin{align}
	\begin{cases}
		\bm{e_R} &= \frac{\partial \bm r}{\partial R} / \left| \frac{\partial \bm r}{\partial R}\right| \\
		\bm{e_{\phi}} &= \frac{\partial \bm r}{\partial \phi} / \left| \frac{\partial \bm r}{\partial \phi}\right| \\
		\bm{e_z} &= \frac{\partial \bm r}{\partial z} / \left| \frac{\partial \bm r}{\partial z}\right|
	\end{cases}
\end{align}
と表される。円筒座標系の場合、各座標軸の速度は
\begin{align}
	\begin{cases}
		v_R &= \frac{\partial r}{\partial t}|\frac{\partial \bm r}{\partial R}| = \dot{R}\\
		v_{\theta} &= \frac{\partial \theta}{\partial t}|\frac{\partial \bm r}{\partial \phi}| = R\dot{\phi}\\
		v_z &= \frac{\partial z}{\partial t}|\frac{\partial \bm r}{\partial z}| = \dot{z} \\
	\end{cases}
\end{align}
となり、円筒座標系での運動量は次のように表される。
\begin{align}
	\begin{cases}
		p_r &= \frac{\partial \mathcal{L}}{\partial R} = \dot{R} = v_R \\
		p_{\phi} &= \frac{\partial \mathcal{L}}{\partial \phi} = R^2\dot{\phi} = R v_{\phi} \\
		p_z &= \frac{\partial \mathcal{L}}{\partial z} = \dot{z} =  v_z \label{momenta_Cylindrical}
	\end{cases}
\end{align}
また、体積積分は、ヤコビアン$\mathcal{J}$を用いて
\begin{align}
\begin{aligned}
	\int dp_R dp_{\phi} dp_z f &= \int \mathcal{J} dv_R dv_{\phi} dv_z\\
	&=
	\int
	\left|
	\begin{array}{ccc}
	 	\cfrac{\partial p_R}{\partial v_R} & \cfrac{\partial p_R}{\partial v_{\phi}} & \cfrac{\partial p_R}{\partial v_z}\\
		\cfrac{\partial p_{\phi}}{\partial v_R} & \cfrac{\partial p_{\phi}}{\partial v_{\phi}} & \cfrac{\partial p_{\phi}}{\partial v_z}\\
		\cfrac{\partial p_{\phi}}{\partial v_R} & \cfrac{\partial p_z}{\partial v_{\phi}} & \cfrac{\partial p_z}{\partial v_z}
	\end{array}
	\right| 
	 dv_R dv_{\phi} dv_{\phi}\\
	&= R \int dv_R dv_{\phi} dv_z f = R \nu    \label{integral_Cylindrical}
\end{aligned}
\end{align}
と変換できる。

したがって、円筒座標系でのハミルトニアンは
\begin{align}
\begin{aligned}
	\mathcal{H} &= \sum_i p_i \dot{q_i} - \mathcal{L} \\
	&= \frac{1}{2}\left(p_R^2 + \frac{p_{\phi}^2}{R^2} + p_z^2 \right) + \Phi(R) \\
\end{aligned}
\end{align}
と表される。式(\ref{CBE})に代入すると、
\begin{align}
	\frac{\partial f}{\partial t} + p_R\frac{\partial f}{\partial R} + \frac{p_{\phi}}{R^2}\frac{\partial f}{\partial \phi} + p_z\frac{\partial f}{\partial z} - \left(\frac{\partial \Phi}{\partial R} - \frac{p_{\phi}^2}{R^3} \right)\frac{\partial f}{\partial p_R} - \frac{\partial \Phi}{\partial \phi}\frac{\partial f}{\partial p_{\phi}} - \frac{\partial \Phi}{\partial z}\frac{\partial f}{\partial p_z} = 0   \label{CBE_Cylindrical}
\end{align}
のようになる。系が定常状態かつ軸対称であると仮定すると、$t,\phi$についての微分は消えるため、
\begin{align}
	p_r\frac{\partial f}{\partial R} + p_z\frac{\partial f}{\partial z} - \left(\frac{\partial \Phi}{\partial R} - \frac{p_{\phi}^2}{R^3} \right)\frac{\partial f}{\partial p_R} - \frac{\partial \Phi}{\partial z}\frac{\partial f}{\partial p_z} = 0    \label{CBE_Cylindrical_simple}
\end{align}
と簡単に書ける。この式に$p_R$をかけて全運動量で積分し、式(\ref{momenta_Cylindrical})を用いて、球座標系の場合と似た論理により
\begin{align}
	\frac{\partial (\nu \overline{v_R^2})}{\partial R} + \frac{\partial (\nu \overline{v_R v_z})}{\partial R} + \nu\left(\frac{\overline{v_R^2} - \overline{v_{\phi}^2}}{R} + \frac{\partial \Phi}{\partial R} \right) = 0   \label{Jeans_Cylindrical_pr}
\end{align}
となる。式(\ref{CBE_Cylindrical_simple})に$p_{\phi}, p_z$をかけて同様の操作をすると、次の式を得る。
\begin{align}
	\frac{1}{R^2}\frac{\partial (R^2\nu \overline{v_R v_{\phi}})}{\partial R} + \frac{\partial (\nu \overline{v_{\phi} v_z})}{\partial z} &= 0 \label{Jeans_Cylindrical_pphi}  \\
	\frac{1}{R}\frac{\partial(R\nu\overline{v_R v_z})}{R} + \frac{\partial(\nu\overline{v_z^2})}{\partial z} + \nu\frac{\partial \Phi}{\partial z} &= 0   \label{Jeans_Cylindrical_pz}
\end{align}
このとき、3つのジーンズ方程式に対して6つの2次のオーダーの運動量成分を持つことになり、方程式は閉じていない。しかし、もしDFが$f(\mathcal{H}, L_z)$の形であるならば、運動量の交差成分は消え、$\overline{v_R^2}=\overline{v_z^2}$となり。このとき、2つの未知数に対して2つの方程式を持つことになり、系は閉じる。特に、式(\ref{Jeans_Cylindrical_pphi})は、積分して次の式を生む\cite{NM76}。
\begin{align}
	\overline{v_R^2}(R,z) = \overline{v_z^2}(R,z) = \frac{1}{\nu(R,z)}\int_z^\infty dz'\nu(R,z')\frac{\partial \Phi}{\partial z'}
\end{align}
$\overline{v_R^2}(R,z)$は分かっているので、式(\ref{Jeans_Cylindrical_pr})から$\overline{v_{\phi}^2}$を得る：
\begin{align}
	\overline{v_{\phi}^2}(R,z) = \overline{v_R^2} + \frac{R}{\nu}\frac{\partial (\nu \overline{v_R^2)}}{\partial R} + R\frac{\partial \Phi}{\partial R}
\end{align}



\section{座標変換}
\subsection{位置の座標変換}

% \subsubsection{赤道直角座標系と赤道座標系}
% 赤道直角座標系の基底ベクトルを$({\bf e}_{\xi},{\bf e}_{\eta},{\bf e}_{\zeta})$、赤道座標系の基底ベクトルを$({\bf e}_{\alpha},{\bf e}_{\delta},{\bf e}_{\gamma})$

% 基底ベクトルの変換は、
% \begin{align}
% \begin{aligned}
%     \left(
% 	\begin{array}{c}
% 	 	{\bf e}_{\xi}\\
% 		{\bf e}_{\eta}\\
% 		{\bf e}_{\zeta}
% 	\end{array}
% 	\right)
% 	=
% 	\left(
% 	\begin{array}{ccc}
% 	 	-\sin{\alpha} & -\cos{\alpha}\sin{\delta} & \cos{\alpha}\cos{\delta}\\
% 		\cos{\alpha} & -\sin{\alpha}\cos{\delta} & \sin{\alpha}\cos{\delta}\\
% 		0 & \cos{\delta} & \sin{\delta}
% 	\end{array}
% 	\right)
% 	\left(
% 	\begin{array}{c}
% 	 	{\bf e}_{\alpha}\\
% 		{\bf e}_{\delta}\\
% 		{\bf e}_{\gamma}
% 	\end{array}
% 	\right)
% \end{aligned}
% \end{align}


\subsubsection{銀河直角座標系と銀河座標系}
x軸:銀河中心方向($l=0^{\circ}, b=0^{\circ}$)

z軸:銀河北極(North Galactic Pole)方向($b=90^{\circ}$)
\begin{align}
\begin{aligned}
	\left(
	\begin{array}{c}
	 	x\\
		y\\
		z
	\end{array}
	\right)
	=
	\left(
	\begin{array}{c}
	 	r\cos{b}\cos{l}\\
	 	r\cos{b}\sin{l}\\
	 	r\sin{b}
	\end{array}
	\right)
\end{aligned}
\end{align}

\begin{align}
\begin{aligned}
	\left(
	\begin{array}{c}
	 	r\\
		l\\
		b
	\end{array}
	\right)
	=
	\left(
	\begin{array}{c}
	 	(x^2 + y^2 + z^2)^{1/2}\\
	 	\arctan{(y/x)}\\
	 	\arcsin{(z/r)}
	\end{array}
	\right)
\end{aligned}
\end{align}
ただし、$\arctan$の定義域は$(-\pi/2, \pi)$であるため、$xy$座標において以下のように場合分けをする必要がある。
\begin{align}
\begin{aligned}
	第一象限 : &\arctan{(y/x)}\\
	第二象限 : &\arctan{(y/x)} + \pi\\
	第三象限 : &\arctan{(y/x)} + \pi\\
	第四象限 : &\arctan{(y/x)} + 2\pi
\end{aligned}
\end{align}


銀河直交座標系のTriad:(${\bf e}_i,{\bf e}_j,{\bf e}_k$)\\
ベクトルの向きは太陽を中心としてそれぞれ銀河中心方向、銀河回転方向、銀河北極方向。\\
銀河座標系の単位ベクトル:(${\bf e}_l,{\bf e}_b,{\bf e}_{\gamma}$)

このとき、銀河直交座標系から銀河座標系に変換する行列を$\bf{S}$とすると、
\begin{align}
\begin{aligned}
	\left(
	\begin{array}{c}
	 	\bf{e}_l\\
		\bf{e}_b\\
		\bf{e}_{\gamma}
	\end{array}
	\right)
	=& \bf{S} \cdot
	\left(
	\begin{array}{c}
	 	\bf{e}_i\\
	 	\bf{e}_j\\
	 	\bf{e}_k
	\end{array}
	\right)\\
	=&
	\left(
	\begin{array}{ccc}
	 	-\sin{l} & \cos{l} & 0\\
	 	-\cos{l}\sin{b} & -\sin{l}\sin{b} & \cos{b}\\
	 	\cos{l}\cos{b} & \sin{l}\cos{b} & \sin{b}
	\end{array}
	\right)
	\left(
	\begin{array}{c}
	 	\bf{e}_i\\
	 	\bf{e}_j\\
	 	\bf{e}_k
	\end{array}
	\right)
\end{aligned}
\end{align}

\begin{align}
\begin{aligned}
	\left(
	\begin{array}{c}
	 	\bf{e}_i\\
		\bf{e}_j\\
		\bf{e}_k
	\end{array}
	\right)
	=& \bf{S}^T \cdot
	\left(
	\begin{array}{c}
	 	\bf{e}_l\\
	 	\bf{e}_b\\
	 	\bf{e}_{\gamma}
	\end{array}
	\right)\\
	=&
	\left(
	\begin{array}{ccc}
	 	-\sin{l} & -\cos{l}\sin{b} & \cos{l}\cos{b}\\
	 	\cos{l} & -\sin{l}\sin{b} & \sin{l}\cos{b}\\
	 	0 & \cos{b} & \sin{b}
	\end{array}
	\right)
	\left(
	\begin{array}{c}
	 	\bf{e}_l\\
	 	\bf{e}_b\\
	 	\bf{e}_{\gamma}
	\end{array}
	\right)
\end{aligned}
\end{align}

\subsubsection{赤道座標から銀河座標}
赤道座標$(\alpha, \delta)$ \\
銀河座標$(l, b)$ \\
$i = 90^{\circ} - \delta_{\rm GP}$\\
銀河赤道の対赤道昇交点 銀経 $l_0$\\
銀河赤道の対赤道昇交点 銀緯 $b_0$\\
銀河赤道の対赤道傾斜角 $l_0$\\

赤道座標から銀河座標への変換
\begin{alignat}{2}
    &\cos b \cos(l-l_0)& &= \cos\delta \cos(\alpha-\alpha_0) \\
    &\cos b \sin(l-l_0)& &= \sin\delta \sin i + \cos\delta \sin(\alpha-\alpha_0) \cos i \\
    &\sin b& &= \sin\delta \cos i - \cos\delta \sin(\alpha-\alpha_0) \sin i
\end{alignat}

銀河座標から赤道座標への変換
\begin{alignat}{2}
    &\cos \delta \cos(\alpha-\alpha_0)& &= \cos b \cos(l-l_0) \\
    &\cos \delta \sin(\alpha-\alpha_0)& &= -\sin b \sin i + \cos b \sin(l-l_0) \cos i \\
    &\sin \delta& &= \sin b \cos i + \cos b \sin(l-l_0) \sin i
\end{alignat}




\subsection{固有運動、視線速度への変換}
座標系と速度の向きを図(\ref{fig:coordinates})のようにとる。このとき、
\begin{align}
\begin{aligned}
    \begin{cases}
    x = -R\cos{\phi}\\
    y = -R\sin{\phi}
    \end{cases}
\end{aligned}
\end{align}

\begin{align}
\begin{aligned}
    \begin{cases}
    R = \sqrt{x^2 + y^2}\\
    \phi = \arctan{c\frac{y}{x}}
    \end{cases}
\end{aligned}
\end{align}


\begin{align}
\begin{aligned}
	\left(
	\begin{array}{c}
	 	V_x \\
	 	V_y
	\end{array}
	\right)
	=
	\left(
	\begin{array}{cc}
	 	\cos{\phi} & \sin{\phi}\\
	 	-\sin{\phi} & \cos{\phi}
	\end{array}
	\right)
	\left(
	\begin{array}{cc}
	 	V_{\phi} \\
	 	V_{\phi}
	\end{array}
	\right)
\end{aligned}
\end{align}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{空間速度ベクトルの座標変換}
\begin{align}
\begin{aligned}
    \left(
	\begin{array}{c}
	 	V_l\\
		V_b\\
		v_R\\
	\end{array}
	\right)
	&=
	\left(
	\begin{array}{c}
	 	\frac{1}{\varpi}\mu_{l}\cos b\\
		\frac{1}{\varpi}\mu_{b}\\
		V_{r}\\
	\end{array}
	\right) \\
	&=
	\left(
	\begin{array}{ccc}
	 	\cos \phi & \sin \phi & 0\\
		-\sin \phi & \cos \phi & 0\\
		0 & 0 & 1
	\end{array}
	\right)
	\left(
	\begin{array}{c}
	 	\frac{1}{\varpi}\mu_{\alpha}\cos \delta\\
		\frac{1}{\varpi}\mu_{\delta}\\
		V_{r}\\
	\end{array}
	\right)
\end{aligned}
\end{align}

$Galactic \ parallactic \ angle \ \phi$は球面三角公式を使えば次のように与えられる。

\begin{align}
\begin{aligned}
    \sin \phi &= \frac{\sin(\alpha-\alpha_{GP})\cos \delta_{GP}}{\cos b} \\
    \cos \phi &= \frac{\cos \delta \sin \delta_{GP} - \sin \delta \cos(\alpha-\alpha_{GP})\cos \delta_{GP}}{\cos b}
\end{aligned}
\end{align}

\subsubsection{直交座標系と円筒座標系}
直交座標系$(x,y,z)$、円筒座標系$(r,\phi,z)$の関係を説明する。座標変換の式は次のようになる。
\begin{align}
\begin{aligned}
    x &= r\cos{\phi}\\
    y &= r\sin{\phi}\\
    z &= z
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
    r &= (x^2 + y^2)^{1/2}\\
    \phi &= \arctan{(y/x)}\\
    z &= z
\end{aligned}
\end{align}
円筒座標系から直交座標系に変換する行列を$\bf{T}$とすると、基底ベクトルの関係は
\begin{align}
\begin{aligned}
    \left(
	\begin{array}{c}
	 	{\bf e}_{x}\\
		{\bf e}_{y}\\
		{\bf e}_{z}
	\end{array}
	\right)
	=& \bf{T} \cdot
	\left(
	\begin{array}{c}
	 	{\bf e}_{r}\\
		{\bf e}_{\phi}\\
		{\bf e}_{z}
	\end{array}
	\right)\\
	=&
	\left(
	\begin{array}{ccc}
	 	\cos{\phi} & \sin{\phi} & 0\\
		-\sin{\phi} & \cos{\phi} & 0\\
		0 & 0 & 1\\
	\end{array}
	\right)
	\left(
	\begin{array}{c}
	 	{\bf e}_{r}\\
		{\bf e}_{\phi}\\
		{\bf e}_{z}
	\end{array}
	\right)
\end{aligned}
\end{align}

\begin{align}
\begin{aligned}
    \left(
	\begin{array}{c}
	 	{\bf e}_{r}\\
		{\bf e}_{\phi}\\
		{\bf e}_{z}
	\end{array}
	\right)
	=&
	\bf{T}^T \cdot
	\left(
	\begin{array}{c}
	 	{\bf e}_{x}\\
		{\bf e}_{y}\\
		{\bf e}_{z}
	\end{array}
	\right)\\
	=&
	\left(
	\begin{array}{ccc}
	 	\cos{\phi} & -\sin{\phi} & 0\\
		\sin{\phi} & \cos{\phi} & 0\\
		0 & 0 & 1
	\end{array}
	\right)
	\left(
	\begin{array}{c}
	 	{\bf e}_{x}\\
		{\bf e}_{y}\\
		{\bf e}_{z}
	\end{array}
	\right)
\end{aligned}
\end{align}

となる。





\subsection{誤差伝搬(GaiaのHPでの説明)}

\href{http://gea.esac.esa.int/archive/documentation/GDR2/Data_processing/chap_cu3ast/sec_cu3ast_intro/ssec_cu3ast_intro_tansforms.html}{GaiaのHPの座標変換・誤差変換についての説明ページ}。


\subsection{誤差伝搬(Bovy)}
観測誤差の伝搬は行列の形式を単純に用いている。観測対象の方向$(\alpha,\delta)$の誤差は無視できるものと仮定するが、例えば、位置天文衛星のスキャン方策が相関した固有運動の値を引き起こす可能性があるため、他の量の誤差の独立性に関する他の仮定はしない。

以下では、一次誤差伝搬の式を示す。我々は、距離の誤差$\sigma_d$を知っていると仮定する。 距離が視差として測定される場合、この距離の不確実性は$\sigma_d = \sigma/\varpi^2$で与えられる。上の変換の非線形性の適切な説明は、この一次計算を超えたり、モンテカルロ不確かさの伝播を採用したりする必要がある。

\subsubsection{Cov$(d,v_R,\mu_{\alpha},\mu_{\delta})$ to Cov$(U,V,W)$}
誤差伝搬Cov$(d,v_R,\mu_{\alpha},\mu_{\delta})$ to Cov$(U,V,W)$は次の二つのパートに分けられる。(1)Cov$(d,\mu_{\alpha},\mu_{\delta})$からCov$(v_{\alpha},v_{\delta})$\\
(2)Cov$(v_R,v_{\alpha},v_{\delta})$からCov$(U,V,W)$。\\
ここで、$v_{\alpha} \equiv \frac{\kappa}{\varpi} \mu_{\alpha} \cos \delta, v_{\delta} \equiv \frac{\kappa}{\varpi}\mu_{\delta}$となる。

変換(1)は非線形である。そのため、次のようにヤコビアンを計算する。
\begin{align}
    \frac{\partial(v_{\alpha}, v_{\delta})}{\partial(d,\mu_{\alpha},\mu_{\delta})} = \kappa
    \left(
	\begin{array}{ccc}
	 	\mu_{\alpha} \cos \delta & d & 0 \\
	 	\mu_{\delta} & 0 & d
	\end{array}
	\right)
\end{align}
そして、次のような式を得る。
\begin{align}
    {\rm Cov}(v_{\alpha},v_{\delta}) = \frac{\partial(v_{\alpha},v_{\delta)}}{d,\mu_{\alpha},\mu_{\delta}} {\rm Cov}(d,\mu_{\alpha},\mu_{\delta}) \frac{\partial(v_{\alpha},v_{\delta})}{\partial(d,\mu_{\alpha},\mu_{\delta})}
\end{align}

変換(2)は次のようになる。
\begin{align}
    {\rm Cov}(U,V,W) = \mathbf{T \ A} \ {\rm Cov}(v_R,v_{\alpha},v_{\delta}) \ \mathbf{A^{\rm T} \ T^{\rm T}}
\end{align}

\subsubsection{Cov$(d,v_R,\mu_{\alpha},\mu_{\delta})$ to Cov$(U,V,W)$}
この誤差伝搬は上の変換と似ている。

\subsubsection{Cov$(\mu_{\alpha},\mu_{\delta})$ to Cov$(\mu_l,\mu_b)$}
赤道座標の固有運動から銀河座標の固有運動への誤差伝搬は次のようになる。
\begin{align}
\begin{aligned}
    {\rm Cov}(\mu_l \cos b,\mu_b) = \mathbf{P} \ {\rm Cov}(\mu_{\alpha} \cos{\delta},\mu_{\delta}) \ \mathbf{P^{\rm T}} \\
    \mathbf{P} = 
    \left(
	\begin{array}{cc}
	 	\cos \phi & \sin \phi \\
	 	-\sin \phi & \cos \phi
	\end{array}
	\right)
\end{aligned}
\end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{模擬データ生成コード}
以下のコードは本論文で行った模擬データ生成のコードである。このコードは\ref{解析3}の速度楕円体を傾けた速度場の模擬データを生成するために使用したコードである。Pythonで記述している。
\lstinputlisting[language=Python,label=code1]{code/MockGenerate_N.py}

\section{MCMCコード}
以下のコードは本論文で行ったMCMCによる解析のコードである。Pythonで記述しており、MCMCの計算にはemcee(\cite{Foreman2013})を使用している。
\lstinputlisting[language=Python,label=code2]{code/mcmc_fitting_mockcatalog_asymmetric_drift_newModel_32.py}